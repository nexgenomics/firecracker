# How to convert a customer app into a guest.


Customer apps come to us as docker containers.
Enabling them to run as guests entails adding software and config to the
user's docker contents, and exporting it to a root filesystem image that
the firecracker system can run as a guest.

Once we have that image, it is further slightly configured for each agent
instantiation.

Here are the steps:

### Load the docker image

Eventually customers will upload their images into a custom registry analogous
to Amazon ECS. We access it from there.

### Run a container from the docker image.

  # docker run --name lab_rat -it --entrypoint "" xxxxx /bin/bash

The magic trick here is the entrypoint clause, which runs the image without
starting up the user's app. We just want the disk contents.

### Copy software into the running container.

  # docker cp setup_lite.sh lab_rat:/tmp
  # docker cp guest_daemon lab_rat:/usr/local/bin
  # docker cp guest_sentences lab_rat:/usr/local/bin

If desired (usually), copy an SSH public key into the image. There's one in
fetaburger:FIRECRACKER. Someday this should become more structured, such as by
allowing the guest_daemon to receive and install an authorized key, but that
has to be done carefully to avoid opening up the surface.

### Do the setup

Inside the running container:
  # /tmp/setup_lite.sh
  # rm /tmp/setup_lite.sh


  (/.ngen/id goes in the agent instance)


### Set up the default app.

use docker inspect <the-image> to get the image metadata. It's a JSON array containing an object which
has several useful things. The Config key is an object with WorkingDir and Entrypoint.
WorkingDir defaults to "/" and Entrypoint is an array because it's a list of arguments.
Be wary that in some cases, the Entrypoint array may start with ["/bin/sh","-c",.....].

In the working guest, we have to arrange for the default app to be started by systemd.
The python script docker_entrypoint.py is intended to do this.
TODO: Not fully tested or automatically integrated to the workflow!


### Make a root filesystem

Exit the container's bash shell, which leaves it stopped but still extant as a docker container.

  # docker export labrat > labrat.tar
  # mkdir labrat
  # tar xf labrat.tar -C labrat
  # sudo chown -R root:root labrat/*
  # sudo mke2fs -t ext4 -L labrat -d labrat -E lazy_itable_init=0,lazy_journal_init=0,packed_meta_blocks=1 labrat.ext4 2G
  # docker rm labrat

Now the guest filesystem is in labrat.ext4. Archive it somehow that is associated with the agent image ID.


### Hiring an agent from the guest filesystem

The root filesystem needs to be personalized for each agent instantiated from it.
Make a simple copy of the root filesystem, mount it, and edit /.ngen/.id which is a JSON file.
Personalize it with the host id, agent id, slot number, and the nats server url.



### SSH

As currently set up, the guests run an SSH server on port 22, which can be accessed from the firecracker host
machine. That works because the bridging setup (which uses the kernel module br_netfilter to run bridged
traffic through iptables) restricts forwarding but permits routing.

So from a shell on the firecracker host, an SSH to a guest machine's IP address (10.0.x.y/16) will work because
the bridge (10.0.0.1/16) is in the same subnet.

Remember, the IP address of the guest is derivable from the slot number: 10.0.x.y, where x is the slot number / 100
and y is the (slot number % 100) + 100.

Any machine in the network with access to the firecracker host can use ssh with local port forwarding to reach
the guest. For example: ssh -L 9999:10.0.0.50:22 192.168.0.194 to open the local port, and then
ssh -p 9999 root@localhost to get to the guest.

Now observe that the guest WILL NOT accept a cleartext password, so you have to use an identity key.
That part is not currently automated, but there are some details in this document, in the section on
setting up software in the guest.

